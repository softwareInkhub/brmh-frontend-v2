name: Deploy Frontend to EC2

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        
    - name: Install dependencies
      run: npm install --legacy-peer-deps
      
    - name: Build application
      run: npm run build
      env:
        NEXT_PUBLIC_BACKEND_URL: http://brmh.in
        NEXT_PUBLIC_AWS_URL: http://brmh-aws-lb-183448151.us-east-1.elb.amazonaws.com
        PERPLEXITY_API_KEY: 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
        REDIS_URL: redis-cli -u redis://default:AbijlE3ijbJC5WEfhlnlCHq8cN2ERzCa@redis-19904.crce182.ap-south-1-1.ec2.redns.redis-cloud.com:19904
      
    - name: Deploy to EC2
      uses: appleboy/ssh-action@master
      with:
        host: ec2-44-216-59-69.compute-1.amazonaws.com
        username: ubuntu
        key: ${{ secrets.EC2_SSH_KEY }}
        script: |
          cd /home/ubuntu/brmh-frontend-v2
          git pull origin main
          npm install --legacy-peer-deps
          npm run build
          # Install PM2 globally with sudo
          sudo npm install -g pm2
          # Stop any existing instances
          pm2 stop brmh-frontend || true
          pm2 delete brmh-frontend || true
          # Start the application as a system service
          pm2 start npm --name "brmh-frontend" -- start
          # Save PM2 process list
          pm2 save
          # Remove any existing startup script
          sudo pm2 unstartup systemd || true
          # Generate new startup script
          sudo env PATH=$PATH:/usr/bin pm2 startup systemd -u ubuntu --hp /home/ubuntu
          # Reload systemd daemon
          sudo systemctl daemon-reload
          # Enable and start the PM2 service
          sudo systemctl enable pm2-ubuntu
          sudo systemctl start pm2-ubuntu
          # Verify the service is running
          sudo systemctl status pm2-ubuntu
          # Check PM2 status
          pm2 status 