name: Deploy Frontend to EC2

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        
    - name: Install dependencies
      run: npm install --legacy-peer-deps
      
    - name: Build application
      run: npm run build
      env:
        NEXT_PUBLIC_BACKEND_URL: http://brmh.in
        NEXT_PUBLIC_AWS_URL: http://brmh-aws-lb-183448151.us-east-1.elb.amazonaws.com
        PERPLEXITY_API_KEY: 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
        REDIS_URL: redis-cli -u redis://default:AbijlE3ijbJC5WEfhlnlCHq8cN2ERzCa@redis-19904.crce182.ap-south-1-1.ec2.redns.redis-cloud.com:19904
      
    - name: Deploy to EC2
      uses: appleboy/ssh-action@master
      with:
        host: ec2-44-216-59-69.compute-1.amazonaws.com
        username: ubuntu
        port: 22
        protocol: tcp
        timeout: "30m"
        key: ${{ secrets.SSH_KEY }}
        script: |
          # Create directory if it doesn't exist
          mkdir -p /home/ubuntu/brmh-frontend-v2
          
          # Check if repository exists
          if [ ! -d "/home/ubuntu/brmh-frontend-v2/.git" ]; then
            # Clone repository if it doesn't exist
            cd /home/ubuntu
            git clone https://github.com/softwareInkhub/brmh-frontend-v2.git
          fi
          
          # Update repository
          cd /home/ubuntu/brmh-frontend-v2
          git fetch origin
          git reset --hard origin/main
          git pull origin main
          
          # Install dependencies and build
          echo "Installing dependencies..."
          npm install --legacy-peer-deps
          
          echo "Building application..."
          # Create a temporary next.config.js without serverOptions
          cp next.config.js next.config.js.bak
          grep -v "serverOptions" next.config.js > next.config.js.tmp
          mv next.config.js.tmp next.config.js
          
          npm run build
          
          # Restore original config
          mv next.config.js.bak next.config.js
          
          echo "Installing PM2..."
          # Install PM2 globally with sudo
          sudo npm install -g pm2
          
          echo "Stopping existing instances..."
          # Stop any existing instances
          pm2 stop brmh-frontend || true
          pm2 delete brmh-frontend || true
          
          echo "Starting application..."
          # Start the application as a system service
          pm2 start npm --name "brmh-frontend" -- start
          
          echo "Saving PM2 process list..."
          # Save PM2 process list
          pm2 save
          
          echo "Setting up systemd service..."
          # Remove any existing startup script
          sudo pm2 unstartup systemd || true
          
          # Generate new startup script
          sudo env PATH=$PATH:/usr/bin pm2 startup systemd -u ubuntu --hp /home/ubuntu
          
          # Reload systemd daemon
          sudo systemctl daemon-reload
          
          # Enable and start the PM2 service
          sudo systemctl enable pm2-ubuntu
          sudo systemctl start pm2-ubuntu
          
          echo "Verifying service status..."
          # Verify the service is running
          sudo systemctl status pm2-ubuntu
          
          # Check PM2 status
          pm2 status 